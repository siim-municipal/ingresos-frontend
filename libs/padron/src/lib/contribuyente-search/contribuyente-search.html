<div class="w-full relative z-50">
  <div class="relative group">
    <div
      class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10"
    >
      @if (store.loading()) {
      <span
        class="animate-spin h-5 w-5 border-2 border-blue-500 border-t-transparent rounded-full"
      ></span>
      } @else {
      <span
        class="material-icons text-slate-400 group-focus-within:text-blue-500 transition-colors"
        >search</span
      >
      }
    </div>

    <input
      type="text"
      [formControl]="searchControl"
      (focus)="onInputFocus()"
      (blur)="onInputBlur()"
      class="block w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm shadow-sm transition-all"
      placeholder="Buscar por RFC, Nombre o Razón Social..."
      autocomplete="off"
    />
  </div>

  @if (isOpen() && store.filter() && !store.loading()) {
  <div
    class="absolute mt-1 w-full bg-white shadow-xl max-h-80 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none animate-fade-in-down z-50"
  >
    @if (store.contribuyentes().length === 0 && !store.error()) {
    <div class="px-4 py-6 text-center text-slate-500">
      <span class="material-icons text-4xl block mb-2 opacity-20"
        >sentiment_dissatisfied</span
      >
      <p>No encontramos contribuyentes con "<b>{{ store.filter() }}</b>"</p>
    </div>
    } @if (store.error()) {
    <div class="px-4 py-3 text-red-600 bg-red-50 flex items-center gap-2">
      <span class="material-icons text-sm">warning</span>
      <span class="text-sm">{{ store.error() }}</span>
    </div>
    } @for (c of store.contribuyentes(); track c.id) {
    <button
      type="button"
      (click)="selectItem(c.id)"
      class="w-full text-left block cursor-pointer relative py-3 px-4 hover:bg-blue-50 transition-colors border-b border-slate-50 last:border-0 group focus:outline-none focus:bg-blue-50 focus:ring-2 focus:ring-inset focus:ring-blue-500"
    >
      <div class="flex justify-between items-start pointer-events-none">
        <div>
          <p
            class="text-sm font-medium text-slate-900"
            [innerHTML]="c.nombreCompleto | highlight: searchControl.value || ''"
          ></p>

          <div class="flex items-center gap-2 mt-0.5">
            <span
              class="text-xs font-mono text-slate-500 bg-slate-100 px-1 rounded"
              [innerHTML]="c.rfc | highlight: searchControl.value || ''"
            >
            </span>

            @if (c.datosAdicionales.curp) {
            <span class="text-[10px] text-slate-400"
              >• CURP: {{ c.datosAdicionales.curp }}</span
            >
            }
          </div>
        </div>

        <span
          class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium uppercase"
          [class.bg-purple-100]="c.tipoPersona === 'FISICA'"
          [class.text-purple-800]="c.tipoPersona === 'FISICA'"
          [class.bg-emerald-100]="c.tipoPersona === 'MORAL'"
          [class.text-emerald-800]="c.tipoPersona === 'MORAL'"
        >
          {{ c.tipoPersona }}
        </span>
      </div>
    </button>
    } @if (store.totalElements() > 10) {
    <div
      class="bg-slate-50 p-2 text-center text-xs text-blue-600 font-medium border-t border-slate-200 cursor-pointer hover:underline"
    >
      Ver los {{ store.totalElements() }} resultados en el padrón completo
    </div>
    }
  </div>
  }
</div>
